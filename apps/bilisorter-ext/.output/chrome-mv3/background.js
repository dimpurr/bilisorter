(function(){"use strict";function W(e){return typeof e=="function"?{main:e}:e}const M="https://api.bilibili.com",q="https://api.anthropic.com",C={SETTINGS:"bilisorter_settings",FOLDERS:"bilisorter_folders",VIDEOS:"bilisorter_videos",SUGGESTIONS:"bilisorter_suggestions",OPERATION_LOG:"bilisorter_operation_log"},B={NAV:"/x/web-interface/nav",FOLDER_LIST:"/x/v3/fav/folder/created/list-all",VIDEO_LIST:"/x/v3/fav/resource/list",MOVE:"/x/v3/fav/resource/move"},X={MESSAGES:"/v1/messages"},V={MIN_BATCH_SIZE:5,MAX_BATCH_SIZE:10,INTER_BATCH_DELAY_MS:300,MAX_RETRIES:1,RATE_LIMIT_PAUSE_MS:3e4};async function F(){try{const[e,i,a]=await Promise.all([chrome.cookies.get({url:"https://www.bilibili.com",name:"SESSDATA"}),chrome.cookies.get({url:"https://www.bilibili.com",name:"bili_jct"}),chrome.cookies.get({url:"https://www.bilibili.com",name:"DedeUserID"})]);return e!=null&&e.value?{SESSDATA:e.value,bili_jct:(i==null?void 0:i.value)||"",DedeUserID:(a==null?void 0:a.value)||""}:(console.log("[BiliAPI] SESSDATA not found, user not logged in"),null)}catch(e){return console.error("[BiliAPI] Error extracting cookies:",e),null}}function Z(e){const i=[`SESSDATA=${e.SESSDATA}`];return e.bili_jct&&i.push(`bili_jct=${e.bili_jct}`),e.DedeUserID&&i.push(`DedeUserID=${e.DedeUserID}`),i.join("; ")}function D(e){return{Cookie:Z(e),Referer:"https://www.bilibili.com",Origin:"https://www.bilibili.com","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}}async function N(e,i){const a=e.headers.get("content-type")||"";if(!e.ok){const s=await e.text().catch(()=>"(unreadable)");throw new Error(`[${i}] HTTP ${e.status} from ${e.url} — ${s.slice(0,200)}`)}if(!a.includes("json")){const s=await e.text().catch(()=>"(unreadable)");throw new Error(`[${i}] Expected JSON but got ${a} from ${e.url} — ${s.slice(0,200)}`)}return e.json()}async function H(e){try{const i=D(e),a=await fetch(`${M}${B.NAV}`,{headers:i}),s=await N(a,"checkAuth");if(s.code!==0||!s.data)return console.log("[BiliAPI] Nav API error:",s),{loggedIn:!1};const o=e.DedeUserID||String(s.data.mid);return{loggedIn:s.data.isLogin,uid:o,username:s.data.uname}}catch(i){return console.error("[BiliAPI] Error checking auth:",i),{loggedIn:!1}}}async function J(e,i){try{const a=D(i),s=await fetch(`${M}${B.FOLDER_LIST}?up_mid=${e}`,{headers:a}),o=await N(s,"fetchFolders");if(o.code!==0||!o.data)throw new Error(`Failed to fetch folders: ${o.code}`);return o.data.list.map(A=>({id:A.id,name:A.title,media_count:A.media_count,sampleTitles:[]}))}catch(a){throw console.error("[BiliAPI] Error fetching folders:",a),a}}async function z(e,i,a){if(i===0)return[];try{const s=D(a),o=Math.ceil(i/20),A=Math.max(1,Math.ceil(Math.random()*o)),x=await fetch(`${M}${B.VIDEO_LIST}?media_id=${e}&pn=${A}&ps=20`,{headers:s}),r=await N(x,"fetchFolderSample");return r.code!==0||!r.data||!r.data.medias?[]:r.data.medias.slice(0,10).map(g=>g.title)}catch(s){return console.error("[BiliAPI] Error fetching folder sample:",s),[]}}async function Y(e,i,a){const s=[];let o=1,A=!0,x=0;const r=D(i);for(;A;)try{const g=await fetch(`${M}${B.VIDEO_LIST}?media_id=${e}&pn=${o}&ps=20`,{headers:r}),u=await N(g,"fetchVideos");if(u.code!==0||!u.data)throw new Error(`Failed to fetch videos: ${u.code}`);const{medias:h,has_more:m,total:S}=u.data;S!==void 0&&(x=S);for(const f of h||[])s.push({bvid:f.bvid,title:f.title,cover:f.cover,upper:f.upper,cnt_info:f.cnt_info,fav_time:new Date(f.fav_time*1e3).toISOString(),intro:f.intro,tags:[],attr:f.attr});a==null||a(s.length,x),A=m,o++}catch(g){throw console.error("[BiliAPI] Error fetching videos:",g),g}return s}async function Q(e,i,a,s){try{const o=D(s),A=new URLSearchParams;A.append("media_id",e.toString()),A.append("target_media_id",i.toString()),A.append("resources",`${a}:2`),A.append("csrf",s.bili_jct);const x=await fetch(`${M}${B.MOVE}`,{method:"POST",headers:{...o,"Content-Type":"application/x-www-form-urlencoded"},body:A.toString()}),r=await N(x,"moveVideo");return r.code===72010002?{success:!0}:r.code!==0?{success:!1,error:r.message||`Error code: ${r.code}`,code:r.code}:{success:!0}}catch(o){return console.error("[BiliAPI] Error moving video:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async function ee(e,i,a,s,o,A){const x=e.filter(m=>m.attr===0),r=i.filter(m=>m.id!==a);if(r.length===0)throw new Error("没有目标收藏夹");if(x.length===0)throw new Error("没有有效视频");const g={},u=V.MAX_BATCH_SIZE,h=Math.ceil(x.length/u);for(let m=0;m<h;m++){const S=x.slice(m*u,(m+1)*u);try{const f=await re(S,r,s,o);for(const[p,E]of Object.entries(f))g[p]=E;A==null||A(m+1,h),m<h-1&&await new Promise(p=>setTimeout(p,V.INTER_BATCH_DELAY_MS))}catch(f){console.error(`[ClaudeAPI] Batch ${m+1} failed:`,f)}}return g}async function re(e,i,a,s){const o=se(e,i),A=await te(o,a,s);return ne(A)}function se(e,i){const a=i.map(o=>`- ${o.name} (ID: ${o.id}, ${o.media_count}个视频)${o.sampleTitles.length>0?`
  示例: `+o.sampleTitles.slice(0,5).join(", "):""}`).join(`
`),s=e.map(o=>{var x;const A=((x=o.tags)==null?void 0:x.length)>0?` [标签: ${o.tags.join(", ")}]`:"";return`- BVID: ${o.bvid}
  标题: ${o.title}
  UP主: ${o.upper.name}${A}`}).join(`
`);return`你是一个视频分类助手。请将以下视频分类到最合适的收藏夹中。

## 可用收藏夹

${a}

## 待分类视频

${s}

## 输出格式

请返回JSON格式：
{
  "classifications": [
    {
      "bvid": "视频BVID",
      "suggestions": [
        {"folder_id": 收藏夹ID, "folder_name": "收藏夹名称", "confidence": 0.95},
        ...
      ]
    }
  ]
}

每个视频最多返回5个建议，按置信度从高到低排序。置信度范围0-1，建议阈值：≥0.8高置信度，0.5-0.8中等，<0.5低置信度。`}async function te(e,i,a){var x,r;const s={model:a,max_tokens:4096,messages:[{role:"user",content:e}],system:"你是一个视频分类助手。请根据视频标题、UP主、标签等信息，将视频分类到最合适的收藏夹。只返回JSON格式，不要添加任何解释性文字。"},o=await fetch(`${q}${X.MESSAGES}`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":i,"Anthropic-Version":"2023-06-01"},body:JSON.stringify(s)});if(!o.ok){const g=await o.json().catch(()=>({}));throw new Error(`Claude API error: ${o.status} - ${((x=g.error)==null?void 0:x.message)||o.statusText}`)}return((r=(await o.json()).content[0])==null?void 0:r.text)||""}function ne(e,i){try{const a=e.match(/\{[\s\S]*\}/);if(!a)throw new Error("No JSON found in response");const s=JSON.parse(a[0]);if(!s.classifications||!Array.isArray(s.classifications))throw new Error("Invalid response format");const o={};for(const A of s.classifications){const{bvid:x,suggestions:r}=A;!x||!Array.isArray(r)||(o[x]=r.filter(g=>g.folder_id&&g.folder_name).slice(0,5).map(g=>({folderId:g.folder_id,folderName:g.folder_name,confidence:Math.max(0,Math.min(1,g.confidence||0))})))}return o}catch(a){return console.error("[ClaudeAPI] Failed to parse response:",a),{}}}const oe=W(()=>{console.log("[BiliSorter] Background service worker started");const e=new Map;let i={inProgress:!1},a={inProgress:!1};function s(r,g){try{return r.postMessage(g),!0}catch{return console.log("[BiliSorter] Port disconnected, continuing operation in background"),!1}}chrome.runtime.onMessage.addListener((r,g,u)=>{if(r.type==="CHECK_AUTH")return o().then(u).catch(h=>{console.error("[BiliSorter] CHECK_AUTH error:",h),u({loggedIn:!1})}),!0;if(r.type==="GET_INDEX_STATUS")return u({...i}),!0;if(r.type==="GET_SUGGEST_STATUS")return u({...a}),!0;if(r.type==="GET_COOKIES")return F().then(u).catch(()=>u(null)),!0;if(r.type==="MOVE_VIDEO"){const{srcFolderId:h,dstFolderId:m,resourceId:S,resourceType:f}=r;return F().then(p=>{if(!p)throw new Error("未登录");return Q(h,m,S,p)}).then(u).catch(p=>u({success:!1,error:p.message})),!0}return!1}),chrome.runtime.onConnect.addListener(r=>{console.log("[BiliSorter] Port connected:",r.name),e.set(r.name,r),r.onMessage.addListener(g=>{g.type==="INDEX"?A(r):g.type==="GET_SUGGESTIONS"&&x(r,g.videos,g.folders)}),r.onDisconnect.addListener(()=>{console.log("[BiliSorter] Port disconnected:",r.name),e.delete(r.name)})});async function o(){const r=await F();if(!r)return console.log("[BiliSorter] No valid cookies found"),{loggedIn:!1};const g=await H(r);return console.log("[BiliSorter] Auth check result:",g),g}async function A(r){var g,u;if(console.log("[BiliSorter] Starting index operation"),i.inProgress){s(r,{type:"ERROR",error:"索引操作已在进行中"});return}i={inProgress:!0,progress:"正在连接..."};try{const h=await F();if(!h){i={inProgress:!1,error:"未登录"},s(r,{type:"ERROR",error:"未登录"});return}const m=await H(h);if(!m.loggedIn||!m.uid){i={inProgress:!1,error:"登录已过期"},s(r,{type:"ERROR",error:"登录已过期"});return}const S=m.uid;console.log("[BiliSorter] Fetching folders for uid:",S);const f=await J(S,h);console.log("[BiliSorter] Fetched",f.length,"folders");for(let v=0;v<f.length;v++){const T=f[v];if(T.media_count>0)try{const $=await z(T.id,T.media_count,h);T.sampleTitles=$}catch($){console.warn("[BiliSorter] Failed to sample folder",T.id,$),T.sampleTitles=[]}i.progress=`已获取 ${v+1}/${f.length} 个收藏夹`,s(r,{type:"FOLDERS_READY",folders:f.slice(0,v+1)}),v<f.length-1&&await new Promise($=>setTimeout($,300))}await chrome.storage.local.set({[C.FOLDERS]:f});const E=((g=(await chrome.storage.local.get(C.SETTINGS))[C.SETTINGS])==null?void 0:g.sourceFolderId)||((u=f[0])==null?void 0:u.id);if(!E){i={inProgress:!1,error:"没有找到收藏夹"},s(r,{type:"ERROR",error:"没有找到收藏夹"});return}console.log("[BiliSorter] Fetching videos from folder:",E),i.progress="正在获取视频...";const P=await Y(E,h,(v,T)=>{i.progress=`正在获取视频... ${v}/${T}`,s(r,{type:"FETCH_PROGRESS",loaded:v,total:T})});console.log("[BiliSorter] Fetched",P.length,"videos");const O=Date.now();await chrome.storage.local.set({[C.FOLDERS]:f,[C.VIDEOS]:P,bilisorter_lastIndexed:O}),i={inProgress:!1},s(r,{type:"INDEX_COMPLETE",videos:P,sourceFolderId:E,timestamp:O}),console.log("[BiliSorter] Index operation complete")}catch(h){console.error("[BiliSorter] Index operation failed:",h);const m=h instanceof Error?h.message:"未知错误";i={inProgress:!1,error:m},s(r,{type:"ERROR",error:m})}}async function x(r,g,u){var h;if(console.log("[BiliSorter] Starting suggestion generation"),a.inProgress){s(r,{type:"ERROR",error:"建议生成已在进行中"});return}a={inProgress:!0,progress:"正在准备AI分析..."};try{const S=(await chrome.storage.local.get(C.SETTINGS))[C.SETTINGS];if(!(S!=null&&S.apiKey)){a={inProgress:!1,error:"未配置 API Key"},s(r,{type:"ERROR",error:"未配置 API Key"});return}const f=(h=u[0])==null?void 0:h.id,p=await ee(g,u,f,S.apiKey,S.model||"claude-3-5-haiku-latest",(E,P)=>{a.progress=`正在分析视频... ${E}/${P}`,s(r,{type:"SUGGESTION_PROGRESS",completed:E,total:P})});await chrome.storage.local.set({[C.SUGGESTIONS]:p}),a={inProgress:!1},s(r,{type:"SUGGESTIONS_COMPLETE",suggestions:p}),console.log("[BiliSorter] Suggestion generation complete")}catch(m){console.error("[BiliSorter] Suggestion generation failed:",m);const S=m instanceof Error?m.message:"未知错误";a={inProgress:!1,error:S},s(r,{type:"ERROR",error:S})}}});var ie=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ae={exports:{}};(function(e,i){(function(a,s){s(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:ie,function(a){var s,o;if(!((o=(s=globalThis.chrome)==null?void 0:s.runtime)!=null&&o.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const A="The message port closed before a response was received.",x=r=>{const g={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(g).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class u extends WeakMap{constructor(n,c=void 0){super(c),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}const h=t=>t&&typeof t=="object"&&typeof t.then=="function",m=(t,n)=>(...c)=>{r.runtime.lastError?t.reject(new Error(r.runtime.lastError.message)):n.singleCallbackArg||c.length<=1&&n.singleCallbackArg!==!1?t.resolve(c[0]):t.resolve(c)},S=t=>t==1?"argument":"arguments",f=(t,n)=>function(d,...b){if(b.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${S(n.minArgs)} for ${t}(), got ${b.length}`);if(b.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${S(n.maxArgs)} for ${t}(), got ${b.length}`);return new Promise((y,I)=>{if(n.fallbackToNoCallback)try{d[t](...b,m({resolve:y,reject:I},n))}catch(l){console.warn(`${t} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,l),d[t](...b),n.fallbackToNoCallback=!1,n.noCallback=!0,y()}else n.noCallback?(d[t](...b),y()):d[t](...b,m({resolve:y,reject:I},n))})},p=(t,n,c)=>new Proxy(n,{apply(d,b,y){return c.call(b,t,...y)}});let E=Function.call.bind(Object.prototype.hasOwnProperty);const P=(t,n={},c={})=>{let d=Object.create(null),b={has(I,l){return l in t||l in d},get(I,l,_){if(l in d)return d[l];if(!(l in t))return;let w=t[l];if(typeof w=="function")if(typeof n[l]=="function")w=p(t,t[l],n[l]);else if(E(c,l)){let R=f(l,c[l]);w=p(t,t[l],R)}else w=w.bind(t);else if(typeof w=="object"&&w!==null&&(E(n,l)||E(c,l)))w=P(w,n[l],c[l]);else if(E(c,"*"))w=P(w,n[l],c["*"]);else return Object.defineProperty(d,l,{configurable:!0,enumerable:!0,get(){return t[l]},set(R){t[l]=R}}),w;return d[l]=w,w},set(I,l,_,w){return l in d?d[l]=_:t[l]=_,!0},defineProperty(I,l,_){return Reflect.defineProperty(d,l,_)},deleteProperty(I,l){return Reflect.deleteProperty(d,l)}},y=Object.create(t);return new Proxy(y,b)},O=t=>({addListener(n,c,...d){n.addListener(t.get(c),...d)},hasListener(n,c){return n.hasListener(t.get(c))},removeListener(n,c){n.removeListener(t.get(c))}}),v=new u(t=>typeof t!="function"?t:function(c){const d=P(c,{},{getContent:{minArgs:0,maxArgs:0}});t(d)}),T=new u(t=>typeof t!="function"?t:function(c,d,b){let y=!1,I,l=new Promise(L=>{I=function(k){y=!0,L(k)}}),_;try{_=t(c,d,I)}catch(L){_=Promise.reject(L)}const w=_!==!0&&h(_);if(_!==!0&&!w&&!y)return!1;const R=L=>{L.then(k=>{b(k)},k=>{let U;k&&(k instanceof Error||typeof k.message=="string")?U=k.message:U="An unexpected error occurred",b({__mozWebExtensionPolyfillReject__:!0,message:U})}).catch(k=>{console.error("Failed to send onMessage rejected reply",k)})};return R(w?_:l),!0}),$=({reject:t,resolve:n},c)=>{r.runtime.lastError?r.runtime.lastError.message===A?n():t(new Error(r.runtime.lastError.message)):c&&c.__mozWebExtensionPolyfillReject__?t(new Error(c.message)):n(c)},K=(t,n,c,...d)=>{if(d.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${S(n.minArgs)} for ${t}(), got ${d.length}`);if(d.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${S(n.maxArgs)} for ${t}(), got ${d.length}`);return new Promise((b,y)=>{const I=$.bind(null,{resolve:b,reject:y});d.push(I),c.sendMessage(...d)})},le={devtools:{network:{onRequestFinished:O(v)}},runtime:{onMessage:O(T),onMessageExternal:O(T),sendMessage:K.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:K.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},G={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return g.privacy={network:{"*":G},services:{"*":G},websites:{"*":G}},P(r,le,g)};a.exports=x(chrome)}else a.exports=globalThis.browser})})(ae);function j(e,...i){}var ge={debug:(...e)=>j(console.debug,...e),log:(...e)=>j(console.log,...e),warn:(...e)=>j(console.warn,...e),error:(...e)=>j(console.error,...e)};try{oe.main()instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw ge.error("The background crashed on startup!"),e}})();
