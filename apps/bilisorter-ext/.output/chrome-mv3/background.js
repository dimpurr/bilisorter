(function(){"use strict";function H(s){return typeof s=="function"?{main:s}:s}const P="https://api.bilibili.com",R={SETTINGS:"bilisorter_settings",FOLDERS:"bilisorter_folders",VIDEOS:"bilisorter_videos",SUGGESTIONS:"bilisorter_suggestions",OPERATION_LOG:"bilisorter_operation_log"},B={NAV:"/x/web-interface/nav",FOLDER_LIST:"/x/v3/fav/folder/created/list-all",VIDEO_LIST:"/x/v3/fav/resource/list",MOVE:"/x/v3/fav/resource/move"};async function F(){try{const[s,g,l]=await Promise.all([chrome.cookies.get({url:"https://www.bilibili.com",name:"SESSDATA"}),chrome.cookies.get({url:"https://www.bilibili.com",name:"bili_jct"}),chrome.cookies.get({url:"https://www.bilibili.com",name:"DedeUserID"})]);return s!=null&&s.value?{SESSDATA:s.value,bili_jct:(g==null?void 0:g.value)||"",DedeUserID:(l==null?void 0:l.value)||""}:(console.log("[BiliAPI] SESSDATA not found, user not logged in"),null)}catch(s){return console.error("[BiliAPI] Error extracting cookies:",s),null}}function M(s){const g=[`SESSDATA=${s.SESSDATA}`];return s.bili_jct&&g.push(`bili_jct=${s.bili_jct}`),s.DedeUserID&&g.push(`DedeUserID=${s.DedeUserID}`),g.join("; ")}async function N(s){try{const g=M(s),n=await(await fetch(`${P}${B.NAV}`,{headers:{Cookie:g}})).json();if(n.code!==0||!n.data)return console.log("[BiliAPI] Nav API error:",n),{loggedIn:!1};const a=s.DedeUserID||String(n.data.mid);return{loggedIn:n.data.isLogin,uid:a,username:n.data.uname}}catch(g){return console.error("[BiliAPI] Error checking auth:",g),{loggedIn:!1}}}async function G(s,g){try{const l=M(g),a=await(await fetch(`${P}${B.FOLDER_LIST}?up_mid=${s}`,{headers:{Cookie:l}})).json();if(a.code!==0||!a.data)throw new Error(`Failed to fetch folders: ${a.code}`);return a.data.list.map(u=>({id:u.id,name:u.title,media_count:u.media_count,sampleTitles:[]}))}catch(l){throw console.error("[BiliAPI] Error fetching folders:",l),l}}async function V(s,g,l){if(g===0)return[];try{const n=M(l),a=Math.ceil(g/20),u=Math.max(1,Math.ceil(Math.random()*a)),A=await(await fetch(`${P}${B.VIDEO_LIST}?media_id=${s}&pn=${u}&ps=20`,{headers:{Cookie:n}})).json();return A.code!==0||!A.data||!A.data.medias?[]:A.data.medias.slice(0,10).map(w=>w.title)}catch(n){return console.error("[BiliAPI] Error fetching folder sample:",n),[]}}async function W(s,g,l){const n=[];let a=1,u=!0,c=0;const A=M(g);for(;u;)try{const x=await(await fetch(`${P}${B.VIDEO_LIST}?media_id=${s}&pn=${a}&ps=20`,{headers:{Cookie:A}})).json();if(x.code!==0||!x.data)throw new Error(`Failed to fetch videos: ${x.code}`);const{medias:O,has_more:T,total:k}=x.data;k!==void 0&&(c=k);for(const f of O||[])n.push({bvid:f.bvid,title:f.title,cover:f.cover,upper:f.upper,cnt_info:f.cnt_info,fav_time:new Date(f.fav_time*1e3).toISOString(),intro:f.intro,tags:[],attr:f.attr});l==null||l(n.length,c),u=T,a++}catch(w){throw console.error("[BiliAPI] Error fetching videos:",w),w}return n}const q=H(()=>{console.log("[BiliSorter] Background service worker started");const s=new Map;chrome.runtime.onMessage.addListener((n,a,u)=>n.type==="CHECK_AUTH"?(g().then(u).catch(c=>{console.error("[BiliSorter] CHECK_AUTH error:",c),u({loggedIn:!1})}),!0):!1),chrome.runtime.onConnect.addListener(n=>{console.log("[BiliSorter] Port connected:",n.name),s.set(n.name,n),n.onMessage.addListener(a=>{a.type==="INDEX"&&l(n)}),n.onDisconnect.addListener(()=>{console.log("[BiliSorter] Port disconnected:",n.name),s.delete(n.name)})});async function g(){const n=await F();if(!n)return console.log("[BiliSorter] No valid cookies found"),{loggedIn:!1};const a=await N(n);return console.log("[BiliSorter] Auth check result:",a),a}async function l(n){var a,u;console.log("[BiliSorter] Starting index operation");try{const c=await F();if(!c){n.postMessage({type:"ERROR",error:"未登录"});return}const A=await N(c);if(!A.loggedIn||!A.uid){n.postMessage({type:"ERROR",error:"登录已过期"});return}const w=A.uid;console.log("[BiliSorter] Fetching folders for uid:",w);const x=await G(w,c);console.log("[BiliSorter] Fetched",x.length,"folders");for(let p=0;p<x.length;p++){const h=x[p];if(h.media_count>0)try{const v=await V(h.id,h.media_count,c);h.sampleTitles=v}catch(v){console.warn("[BiliSorter] Failed to sample folder",h.id,v),h.sampleTitles=[]}n.postMessage({type:"FOLDERS_READY",folders:x.slice(0,p+1)}),await new Promise(v=>setTimeout(v,10))}const T=((a=(await chrome.storage.local.get(R.SETTINGS))[R.SETTINGS])==null?void 0:a.sourceFolderId)||((u=x[0])==null?void 0:u.id);if(!T){n.postMessage({type:"ERROR",error:"没有找到收藏夹"});return}console.log("[BiliSorter] Fetching videos from folder:",T);let k=0;const f=await W(T,c,(p,h)=>{k=p,n.postMessage({type:"FETCH_PROGRESS",loaded:p,total:h})});console.log("[BiliSorter] Fetched",f.length,"videos");const C=Date.now();n.postMessage({type:"INDEX_COMPLETE",videos:f,sourceFolderId:T,timestamp:C}),await chrome.storage.local.set({[R.FOLDERS]:x,[R.VIDEOS]:f,bilisorter_lastIndexed:C}),console.log("[BiliSorter] Index operation complete")}catch(c){console.error("[BiliSorter] Index operation failed:",c),n.postMessage({type:"ERROR",error:c instanceof Error?c.message:"未知错误"})}}});var K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Z={exports:{}};(function(s,g){(function(l,n){n(s)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:K,function(l){var n,a;if(!((a=(n=globalThis.chrome)==null?void 0:n.runtime)!=null&&a.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const u="The message port closed before a response was received.",c=A=>{const w={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(w).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class x extends WeakMap{constructor(r,o=void 0){super(o),this.createItem=r}get(r){return this.has(r)||this.set(r,this.createItem(r)),super.get(r)}}const O=e=>e&&typeof e=="object"&&typeof e.then=="function",T=(e,r)=>(...o)=>{A.runtime.lastError?e.reject(new Error(A.runtime.lastError.message)):r.singleCallbackArg||o.length<=1&&r.singleCallbackArg!==!1?e.resolve(o[0]):e.resolve(o)},k=e=>e==1?"argument":"arguments",f=(e,r)=>function(i,...d){if(d.length<r.minArgs)throw new Error(`Expected at least ${r.minArgs} ${k(r.minArgs)} for ${e}(), got ${d.length}`);if(d.length>r.maxArgs)throw new Error(`Expected at most ${r.maxArgs} ${k(r.maxArgs)} for ${e}(), got ${d.length}`);return new Promise((b,S)=>{if(r.fallbackToNoCallback)try{i[e](...d,T({resolve:b,reject:S},r))}catch(t){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,t),i[e](...d),r.fallbackToNoCallback=!1,r.noCallback=!0,b()}else r.noCallback?(i[e](...d),b()):i[e](...d,T({resolve:b,reject:S},r))})},C=(e,r,o)=>new Proxy(r,{apply(i,d,b){return o.call(d,e,...b)}});let p=Function.call.bind(Object.prototype.hasOwnProperty);const h=(e,r={},o={})=>{let i=Object.create(null),d={has(S,t){return t in e||t in i},get(S,t,E){if(t in i)return i[t];if(!(t in e))return;let m=e[t];if(typeof m=="function")if(typeof r[t]=="function")m=C(e,e[t],r[t]);else if(p(o,t)){let I=f(t,o[t]);m=C(e,e[t],I)}else m=m.bind(e);else if(typeof m=="object"&&m!==null&&(p(r,t)||p(o,t)))m=h(m,r[t],o[t]);else if(p(o,"*"))m=h(m,r[t],o["*"]);else return Object.defineProperty(i,t,{configurable:!0,enumerable:!0,get(){return e[t]},set(I){e[t]=I}}),m;return i[t]=m,m},set(S,t,E,m){return t in i?i[t]=E:e[t]=E,!0},defineProperty(S,t,E){return Reflect.defineProperty(i,t,E)},deleteProperty(S,t){return Reflect.deleteProperty(i,t)}},b=Object.create(e);return new Proxy(b,d)},v=e=>({addListener(r,o,...i){r.addListener(e.get(o),...i)},hasListener(r,o){return r.hasListener(e.get(o))},removeListener(r,o){r.removeListener(e.get(o))}}),X=new x(e=>typeof e!="function"?e:function(o){const i=h(o,{},{getContent:{minArgs:0,maxArgs:0}});e(i)}),j=new x(e=>typeof e!="function"?e:function(o,i,d){let b=!1,S,t=new Promise(_=>{S=function(y){b=!0,_(y)}}),E;try{E=e(o,i,S)}catch(_){E=Promise.reject(_)}const m=E!==!0&&O(E);if(E!==!0&&!m&&!b)return!1;const I=_=>{_.then(y=>{d(y)},y=>{let L;y&&(y instanceof Error||typeof y.message=="string")?L=y.message:L="An unexpected error occurred",d({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(y=>{console.error("Failed to send onMessage rejected reply",y)})};return I(m?E:t),!0}),Y=({reject:e,resolve:r},o)=>{A.runtime.lastError?A.runtime.lastError.message===u?r():e(new Error(A.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?e(new Error(o.message)):r(o)},U=(e,r,o,...i)=>{if(i.length<r.minArgs)throw new Error(`Expected at least ${r.minArgs} ${k(r.minArgs)} for ${e}(), got ${i.length}`);if(i.length>r.maxArgs)throw new Error(`Expected at most ${r.maxArgs} ${k(r.maxArgs)} for ${e}(), got ${i.length}`);return new Promise((d,b)=>{const S=Y.bind(null,{resolve:d,reject:b});i.push(S),o.sendMessage(...i)})},Q={devtools:{network:{onRequestFinished:v(X)}},runtime:{onMessage:v(j),onMessageExternal:v(j),sendMessage:U.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:U.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},$={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return w.privacy={network:{"*":$},services:{"*":$},websites:{"*":$}},h(A,Q,w)};l.exports=c(chrome)}else l.exports=globalThis.browser})})(Z);function D(s,...g){}var z={debug:(...s)=>D(console.debug,...s),log:(...s)=>D(console.log,...s),warn:(...s)=>D(console.warn,...s),error:(...s)=>D(console.error,...s)};try{q.main()instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(s){throw z.error("The background crashed on startup!"),s}})();
